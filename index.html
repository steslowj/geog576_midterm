<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <meta name="description" content="UW-Madison Geog 576 Midterm Project" />
    <meta name="author" content="Jessica Steslow" />
    
    <title>Dragon Map</title>
    <link rel="icon" type="image/x-icon" href="dragon.png" />

    <script src="https://js.arcgis.com/calcite-components/1.9.2/calcite.esm.js" type="module"></script>
    <link rel="stylesheet" href="https://js.arcgis.com/calcite-components/1.9.2/calcite.css" />

    <script src="https://js.arcgis.com/4.27/"></script>
    <link rel="stylesheet" href="https://js.arcgis.com/4.27/esri/themes/dark/main.css" />
  </head>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
    body {
      display: flex;
    }
    calcite-loader {
      align-self: center;
      justify-self: center;
    }
    calcite-shell-panel {
      --calcite-shell-panel-min-width: 320px;
      --calcite-ui-brand: #71c96e;
      --calcite-ui-brand-hover: #67b564;
    }
    #header-title {
      margin-left: 1rem;
      margin-right: 1rem;
      padding: 0 2.8rem;
      margin: 0.2rem 0.2rem;
    }
    #queryAttributes-container {
      padding: 0.75rem;
    }
    #queryAttributes-grid {
      display: grid;
      grid-template-columns: auto 230px;
      grid-row-gap: 3px;
      align-content: center;
    }
    #queryName-grid {
      display: grid;
      grid-template-columns: auto 240px;
      align-content: center;
      margin-top: 4px;
      margin-bottom: 18px;
    }
    .attributeLabel {
      font-size: 90%;
      display: flex;
      align-items: flex-end;
      font-style: italic;
    }

    #information-container, #layer-reference-container, #addDragon-container, #credits-container {
      padding: 0.75rem;
      line-height: 1.2rem;
    }
    #side-panel-information h4 {
      margin-bottom:0rem;
      display: flex;
      align-items: center;
    }
    #side-panel-information p {
      margin-top: 0.5rem;
      margin-left: 2rem;
    }
    #side-panel-information calcite-icon {
      margin-right: 0.4rem;
    }
    #addDragon-container a {
      color: grey;
    }
    #addDragon-container a:hover {
      color: white;
    }
    calcite-rating {
      margin-top: 0.25rem;
    }
    #resultsDiv {
      overflow: auto;
    }
  </style>

  <body>

    <calcite-shell content-behind class="calcite-mode-dark">
      <h2 id="header-title" slot="header">
        Dragon Map
      </h2>
      <!-- Calcite Shell Panel to organize UI -->
      <calcite-shell-panel slot="panel-start" display-mode="float">
        <calcite-action-bar slot="action-bar">
          <calcite-action-group>
            <calcite-action data-action-id="information" icon="information" text="About"></calcite-action>
            <calcite-action data-action-id="queryAttributes" icon="data-magnifying-glass" text="Search"></calcite-action>
          </calcite-action-group>
          <calcite-action-group>
            <calcite-action data-action-id="toggleLayers" icon="layers" text="Toggle Layers"></calcite-action>
            <calcite-action data-action-id="layersReference" icon="layers-reference" text="Layer Info"></calcite-action>
          </calcite-action-group>
          <calcite-action-group>
            <calcite-action data-action-id="addDragon" icon="plus-circle" text="Add a Dragon"></calcite-action>
          </calcite-action-group>
          <calcite-action-group slot="bottom-actions">
            <calcite-action data-action-id="credits" icon="users" text="Credits"></calcite-action>
          </calcite-action-group>
        </calcite-action-bar>

        <!-- Map-specific panels (each one provides a div for a ArcGIS Maps SDK for JavaScript widget) -->
        <calcite-panel heading="Toggle Layers" height-scale="l" data-panel-id="toggleLayers" hidden>
          <div id="layers-container"></div>
        </calcite-panel>

        <!-- Info panel -->
        <calcite-panel heading="About" height-scale="l" data-panel-id="information" hidden>
          <div id="information-container">
            This map is meant to be an inclusive collection of dragons from many genres: folklore, urban legends, history, biology. Click on the points to learn more about different dragons!</br>
          <p>Use the tools on the left side panel to interact with the data on the map.</p>
            <div id="side-panel-information">
              <h4><calcite-icon icon="data-magnifying-glass"></calcite-icon> Search the Database</h4>
              <p>Select attributes related to dragons to search the database. Results given will correspond to points on the map.</p>
              <h4><calcite-icon icon="layers"></calcite-icon> Toggle Layers</h4>
              <p>Explore layers related to reptile diversity!</p>
              <h4><calcite-icon icon="layers-reference"></calcite-icon>Layer Information</h4>
              <p>Info on the reptile diversity layers.</p>
              <h4><calcite-icon icon="plus-circle"></calcite-icon> Add a Dragon</h4>
              <p>This project is made better by including knowledge from multiple backgrounds! Check this tool to read about how to add a new dragon into the database.</p>
            </div>
          </div>
        </calcite-panel>
      
        <!-- Layer Info panel -->
        <calcite-panel height-scale="l" heading="Layer Information" data-panel-id="layersReference" hidden>
          <div id="layer-reference-container">
            <div id="side-panel-information">
              <h4><calcite-icon scale="m" icon="layer"></calcite-icon>Reptile Richness and Rarity</h4>
              <p>This layer showsbiodiversity of animal and plant groups expressed as percentile rank, from the Map of Life Living Atlas Publisher. <i>Species richness</i> is the number of species ranges estimated to occur in each grid cell. <i>Species rarity</i> is the average range-restrictedness of all species expected to occuur in each cell. </p>
              <h4><calcite-icon scale="m" icon="layer"></calcite-icon>Amphibian Richness and Rarity</h4>
              <p>The same as above but with amphibians.</p>
              <h4><calcite-icon scale="m" icon="layer"></calcite-icon>Number of Terrestrial Lizard and Snake Species</h4>
              <p>Data from the WWF WildFinder database for species occurrences by ecoregion.</p>
            </div>
          </div>
        </calcite-panel>
      
        <!-- Add a Dragon panel -->
        <calcite-panel height-scale="l" heading="Add a Dragon" data-panel-id="addDragon" hidden>
          <div id="addDragon-container">
            Submission Guidelines:</br></br>
            Click the Edit button to add a dragon to the dragon dataset. This will open a new page with Survey123. The quality of the database depends on the consistency of submissions. Please follow the guided survey with a submission.</br></br>
            <a href="https://arcg.is/1reu9q" target="blank">Add a Dragon Survey</a>
          </div>
        </calcite-panel>

        <!-- Credit panel -->
        <calcite-panel height-scale="l" heading="Credits" data-panel-id="credits" hidden>
          <div id="credits-container">
            Created by Jessica Steslow for the University of Wisconsin-Madison Geography 576 midterm project, October 2023
            <p>Layer Credits:</p>
            <dl>
              <dt>Terrestrial Species Richness and Rarity</dt>
              <dd>- Feature layer by Map of Life Living Atlas Publisher</dd>
              <dd>- Link to ArcGIS overview page: 
                <a href="https://www.arcgis.com/home/item.html?id=08fbd2c0db94442db4e4835092dcc01b#overview" target="blank">link</a>
                </dd>
              <dt>Number of Terrestrial Lizard and Snake Species</dt>
              <dd>- Link to ArcGIS overview page: 
                <a href="https://www.arcgis.com/home/item.html?id=4d8d7703ec5e4337a0ac1a20edb6a5d3" target="blank">link</a>
                </dd>
              <dt>Basemap</dt>
              <dd>- "Geogrgian" Basemap created by John Nelson</dd>
              <dd>- Link to ArcGIS overview page: 
                <a href="https://www.arcgis.com/home/item.html?id=4d8d7703ec5e4337a0ac1a20edb6a5d3" target="blank">link</a>
              </dd>
            </dl> 
          </div>
        </calcite-panel>

        <!-- queryAttributes panel -->
        <calcite-panel height-scale="l" heading="Search the Database" data-panel-id="queryAttributes" hidden>
          <calcite-block collapsible open heading="Search by Attributes" description="">
            <calcite-icon scale="s" slot="icon" icon="search"></calcite-icon>
          <div id="queryAttributes-container" style="padding: 5px; max-width: 100%;">
            <div id="queryAttributes-grid">
              <div class="attributeLabel">Category</div>
              <div>
                <calcite-segmented-control id="categorySelection" layout="horizontal" width="full">
                  <calcite-segmented-control-item value="Mythology">Mythology</calcite-segmented-control-item>
                  <calcite-segmented-control-item value="Zoology">Zoology</calcite-segmented-control-item>
                  <calcite-segmented-control-item value="Any" checked>Any</calcite-segmented-control-item>
                </calcite-segmented-control>
              </div>
              <div class="attributeLabel">Wings</div>
              <div>
                <calcite-segmented-control id="wingSelection" layout="horizontal" width="full">
                  <calcite-segmented-control-item value="Yes">Wings</calcite-segmented-control-item>
                  <calcite-segmented-control-item value="No">No Wings</calcite-segmented-control-item>
                  <calcite-segmented-control-item value="Any" checked>Any</calcite-segmented-control-item>
                </calcite-segmented-control>
              </div>
              <div class="attributeLabel"># Heads</div>
              <div>
                <calcite-segmented-control id="headSelection" layout="horizontal" width="full">
                  <calcite-segmented-control-item value="1">1</calcite-segmented-control-item>
                  <calcite-segmented-control-item value="2">2</calcite-segmented-control-item>
                  <calcite-segmented-control-item value="3">3</calcite-segmented-control-item>
                  <calcite-segmented-control-item value="More than 3">>3</calcite-segmented-control-item>
                  <calcite-segmented-control-item value="Any" checked>Any</calcite-segmented-control-item>
                </calcite-segmented-control>
              </div>
              <div class="attributeLabel"># Limbs</div>
              <div>
                <calcite-segmented-control id="limbSelection" layout="horizontal" width="full">
                  <calcite-segmented-control-item value="0">0</calcite-segmented-control-item>
                  <calcite-segmented-control-item value="2">2</calcite-segmented-control-item>
                  <calcite-segmented-control-item value="4">4</calcite-segmented-control-item>
                  <calcite-segmented-control-item value="More than 4">>4</calcite-segmented-control-item>
                  <calcite-segmented-control-item value="Any" checked>Any</calcite-segmented-control-item>
                </calcite-segmented-control>
              </div>
            </div>
            <div id="queryName-grid">
              <div class="attributeLabel" style="margin-left: 4px">Name</div>
              <div><calcite-input-text id="nameSelection" placeholder="(optional)"></calcite-input-text></div>
            </div>
            <div style="max-width: 100%; display: flex; flex-direction: row; margin: 4px 0;">
              <calcite-button id="query-dragons" width="half" appearance="solid" alignment="center" scale="s">
                Query Dragons
              </calcite-button>
              <calcite-button id="clear-query" width="half" appearance="outline" alignment="center" scale="s">
                Clear query
              </calcite-button>
            </div>
          </div>
          </calcite-block>
          <calcite-panel id="resultsDiv">
            <h3 class="heading" id="resultsHeading" slot="header-content" style="padding: 0px; margin: 0px;">Results</h3>
            <div id="results"></div>
          </calcite-panel>
        </calcite-panel>

      <!-- End of calcite items, div for map in viewDiv-->
      </calcite-shell-panel>
      <div id="viewDiv"></div>
    </calcite-shell>
  </body>

  <script>
    require([
      "esri/config",
      "esri/Basemap",
      "esri/Map",   
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/widgets/Expand",
      "esri/widgets/LayerList",
      "esri/widgets/Legend",
      "esri/widgets/Search",
      "esri/smartMapping/renderers/relationship",
      "esri/smartMapping/symbology/relationship"
    ], (esriConfig, Basemap, Map, MapView, FeatureLayer, Expand, LayerList, Legend, Search, relationshipRendererCreator, relationshipSchemes) => 
    
    (async () => {
      
    esriConfig.apiKey = "AAPK9c2d1c71e0c54fea8c41854d79e2bb2aRY4BboQbjkrg1gzIR4byHHAPQAnvnqnY0kwBUXQfbQGvJjGbV3it18SqxWbjCtON";

      // Georgian Basemap created by j_nelson
      const basemap = new Basemap({
        portalItem: {
          id: "83ebb96f9f99446085888bb5341c5afd"
        }
      });

      const map = new Map({
        basemap
      });
      
      const numberTerrestrialLayer = new FeatureLayer({
        url: "https://cumulus.tnc.org/arcgis/rest/services/Atlas/TerrestrialMaps/MapServer/9",
        outFields: ["*"],
        title: "Number of Terrestrial Lizard and Snake Species",
        visible: false
      });

      const amphibianRichnessAndRarityLayer = new FeatureLayer({
        url: "https://services9.arcgis.com/IkktFdUAcY3WrH25/arcgis/rest/services/GlobalTerrRaR_025deg/FeatureServer",
        outFields: ["Rich_amph", "Rar_amph"],
        title: "Amphipian Richness and Rarity",
        visible: false
      });
      
      const reptileRichnessAndRarityLayer = new FeatureLayer({
        url: "https://services9.arcgis.com/IkktFdUAcY3WrH25/arcgis/rest/services/GlobalTerrRaR_025deg/FeatureServer",
        outFields: ["Rich_rept", "Rar_rept"],
        title: "Reptile Richness and Rarity",
        visible: false
      });
      
      const dragonLayer = new FeatureLayer({
        url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/survey123_858ef0ef96d24c05973f1b8c29755f2b_results/FeatureServer",
        outFields: ["name","category","description","wings","number_of_heads","number_of_limbs"],
        title: "Dragons",
        renderer: await setRenderer(),
        popupTemplate: createPopupTemplate()
      });


      const view = new MapView({
        map,
        container: "viewDiv",
        center: [-98, 37],
        zoom: 3,
        padding: {
          left: 49
        }
      });
      
      // Returns the Blueberry Parfait scheme
      let blueberryScheme = relationshipSchemes.getSchemeByName({
        basemap: map.basemap,
        geometryType: "polygon",
        name: "Blueberry Parfait"
      });

      
      const amphibianRichnessAndRarityParams = {
        layer: amphibianRichnessAndRarityLayer,
        view: view,
        field1: {
          field: "Rich_amph"
        },
        field2: {
          field: "Rar_amph"
        },
        defaultSymbolEnabled: false,
        relationshipScheme: blueberryScheme
      }
      
      relationshipRendererCreator.createRenderer(amphibianRichnessAndRarityParams)
        .then(function(response){
          amphibianRichnessAndRarityLayer.renderer = response.renderer;
      });
      
      const reptileRichnessAndRarityParams = {
        layer: reptileRichnessAndRarityLayer,
        view: view,
        field1: {
          field: "Rich_rept"
        },
        field2: {
          field: "Rar_rept"
        },
        defaultSymbolEnabled: false,
        relationshipScheme: blueberryScheme
      }

      relationshipRendererCreator.createRenderer(reptileRichnessAndRarityParams)
        .then(function(response){
        reptileRichnessAndRarityLayer.renderer = response.renderer;
      });
      
      map.add(numberTerrestrialLayer);
      map.add(amphibianRichnessAndRarityLayer);
      map.add(reptileRichnessAndRarityLayer);
      map.add(dragonLayer);

      const searchWidget = new Search({
        view: view
      });
            
      const searchExpand = new Expand({
        expandIcon: "search",  // see https://developers.arcgis.com/calcite-design-system/icons/
        expandTooltip: "Search map by location", // optional, defaults to "Expand" for English locale
        view: view,
        content: searchWidget
      });
      view.ui.add(searchExpand, {
        position: "top-right"
      });
      
      view.ui.move("zoom", "top-right");
      
      // Add a legend instance to the panel of a
      // ListItem in a LayerList instance
      const layerList = new LayerList({
        view: view,
        container: "layers-container",
        listItemCreatedFunction: (event) => {
          const item = event.item;
          if (item.layer.type != "group") {
            // don't show legend twice
            item.panel = {
              content: "legend",
              open: true
            };
          }
        } // end of listItemCreatedFunction
      });

      // function to manage calcite items after view has finished loading
      view.when(() => {

        let activeWidget;

        const handleActionBarClick = ({ target }) => {
          if (target.tagName !== "CALCITE-ACTION") {
            return;
          }

          if (activeWidget) {
            document.querySelector(`[data-action-id=${activeWidget}]`).active = false;
            document.querySelector(`[data-panel-id=${activeWidget}]`).hidden = true;
          }

          const nextWidget = target.dataset.actionId;
          if (nextWidget !== activeWidget) {
            document.querySelector(`[data-action-id=${nextWidget}]`).active = true;
            document.querySelector(`[data-panel-id=${nextWidget}]`).hidden = false;
            activeWidget = nextWidget;
          } else {
            activeWidget = null;
          }
        };

        document.querySelector("calcite-action-bar").addEventListener("click", handleActionBarClick);

        let actionBarExpanded = false;

        document.addEventListener("calciteActionBarToggle", event => {
          actionBarExpanded = !actionBarExpanded;
          view.padding = {
            left: actionBarExpanded ? 150 : 49
          };
        });

        //document.querySelector("calcite-shell").hidden = false;
        //document.querySelector("calcite-loader").hidden = true;

      }); //end of calcite view.when
      
          const dragonLayerView = await view.whenLayerView(dragonLayer);

          // get UI components involved in query
          const categorySelection = document.getElementById("categorySelection");
          const wingSelection = document.getElementById("wingSelection");
          const headSelection = document.getElementById("headSelection");
          const limbSelection = document.getElementById("limbSelection");
          const nameSelection = document.getElementById("nameSelection");
          const clearQueryButton = document.getElementById("clear-query");
          const queryDragonsButton = document.getElementById("query-dragons");
      


          // This function runs when user clicks on query dragons button
          document.getElementById("query-dragons").addEventListener("click", async () => {
            clearQueryButton.appearance = "outline";
            queryDragonsButton.appearance = "solid";

            // Building the SQL where clause based on user selection and Feature Layer field names
            // Very sensitive to value of calcite items in DOM
            
            let whereClause = (categorySelection.value == "Any") ? 
                "category LIKE '%'": "category = '" + categorySelection.value + "'";
            
            whereClause = (wingSelection.value == "Any") ? 
              whereClause: whereClause + " AND " + "wings = '" + wingSelection.value + "'";
            
            whereClause = (headSelection.value == "Any") ?
              whereClause: whereClause + " AND " + "number_of_heads = '" + headSelection.value + "'";
            
            whereClause = (limbSelection.value == "Any") ?
              whereClause: whereClause + " AND " + "number_of_limbs = '" + limbSelection.value + "'";
            
            whereClause = (nameSelection.value) ? whereClause + " AND name LIKE '" + nameSelection.value + "'" : whereClause;
             
            //console.log(whereClause);

            // query all features from the layer and only return
            // attributes specified in outFields.
            const query = { // autocasts as Query
              where: whereClause,
              returnGeometry: true,
              outFields: ["name", "category", "description", "objectid"],
              orderByFields: ["name"]
            };
            

            const results = await dragonLayer.queryFeatures(query);

            document.getElementById("resultsDiv").style.display = "block";
            document.getElementById("resultsHeading").innerHTML = `Results: ${results.features.length} dragons`;
            document.getElementById("results").innerHTML = "";

            graphics = results.features;
            graphics.forEach((result, index) => {
              const attributes = result.attributes;
              const item = document.createElement("calcite-pick-list-item");
              item.setAttribute("label", attributes.name);
              item.setAttribute("value", index);

              item.setAttribute("description", attributes.description);
              item.addEventListener("click", dragonResultClickHandler);
              document.getElementById("results").appendChild(item);
            });

            // set query for the queryObjectIds.
            query.orderByFields = [""];
            const objectIds = await dragonLayer.queryObjectIds(query);
            dragonLayerView.filter = {
              objectIds
            };

          });

          // this function runs when user clicks on the dragon
          // in the list shown on the right side of the app
          function dragonResultClickHandler(event) {
            const target = event.target;
            const resultId = target.getAttribute("value");

            // get the graphic corresponding to the clicked zip code
            const result = resultId && graphics && graphics[parseInt(resultId)];

            if (result) {
              view.openPopup({
                features: [result],
                location: result.geometry
              });
            }
          }

          clearQueryButton.addEventListener("click", () => {
            clearQueryButton.appearance = "solid";
            queryDragonsButton.appearance = "outline";
            dragonLayerView.filter = null;
            view.closePopup();
            document.getElementById("resultsHeading").innerHTML = `Results`;
            document.getElementById("results").innerHTML = "";
          });

          async function setRenderer() {
             let dragonRenderer = {
              type: "unique-value", // autocasts as new UniqueValueRenderer()
              field: "category",
              //defaultSymbol: { type: "simple-marker"}, // autocasts as new SimpleMarkerSymbol()
              uniqueValueInfos: [{
                value: "Mythology",
                symbol: {
                  type: "simple-marker",  // autocasts as new SimpleMarkerSymbol()
                  color: [ 255, 128, 0, 0.8 ],
                  outline: {  // autocasts as new SimpleLineSymbol()
                    width: 1,
                    color: "black"
                  }
                }
              }, {
                value: "Zoology",
                symbol: {
                  type: "simple-marker",  // autocasts as new SimpleFillSymbol()
                  color: [ 128, 255, 0, 0.8 ],
                  outline: {  // autocasts as new SimpleLineSymbol()
                    width: 1,
                    color: "black"
                  }
                }
              }]
            };

            return dragonRenderer;
          }

          function createPopupTemplate() {
            return {
              title: "{name}",
              content: [
                {
                  type: "fields",
                  fieldInfos: [
                    {
                      fieldName: "category",
                      label: "Category"
                    },
                    {
                      fieldName: "description",
                      label: "Description"
                    },
                    {
                      fieldName: "wings",
                      label: "Wings?"
                    },
                    {
                      fieldName: "number_of_heads",
                      label: "Number of heads"
                    },
                    {
                      fieldName: "number_of_limbs",
                      label: "Number of limbs"
                    }
                  ]
                }
              ]
            };
          }

      
    })());
  </script>
</html>
